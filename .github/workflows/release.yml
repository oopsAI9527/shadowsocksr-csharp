name: Build and Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup NuGet
        uses: nuget/setup-nuget@v1

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Prepare .NET 4.0 reference assemblies via NuGet
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $out = '_ref'
          New-Item -ItemType Directory -Path $out -Force | Out-Null
          nuget install Microsoft.NETFramework.ReferenceAssemblies.net40 -Version 1.0.3 -OutputDirectory $out -ExcludeVersion
          $pkg = Join-Path $out 'Microsoft.NETFramework.ReferenceAssemblies.net40'
          $ref40 = Join-Path $pkg 'build\.NETFramework\v4.0'
          if (-not (Test-Path $ref40)) { throw "net40 reference assemblies not found: $ref40" }
          # Export for subsequent steps
          $ref40Abs = (Resolve-Path -Path $ref40).Path
          "REF40=$ref40Abs" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Prepare .NET 2.0 reference assemblies via NuGet
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $out = '_ref'
          nuget install Microsoft.NETFramework.ReferenceAssemblies.net20 -Version 1.0.3 -OutputDirectory $out -ExcludeVersion
          $pkg = Join-Path $out 'Microsoft.NETFramework.ReferenceAssemblies.net20'
          $ref20 = Join-Path $pkg 'build\.NETFramework\v2.0'
          if (-not (Test-Path $ref20)) { throw "net20 reference assemblies not found: $ref20" }
          $ref20Abs = (Resolve-Path -Path $ref20).Path
          "REF20=$ref20Abs" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Restore packages
        run: nuget restore shadowsocks-csharp.sln

      - name: Build .NET 2.0 client
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          if (-not $env:REF20) { throw "Missing REF20 environment variable" }
          $env:FrameworkPathOverride = $env:REF20
          msbuild shadowsocks-csharp/shadowsocks-csharp.csproj /p:Configuration=Release /p:Platform=AnyCPU /m

      - name: Build .NET 4.0 client
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          if (-not $env:REF40) { throw "Missing REF40 environment variable" }
          $env:FrameworkPathOverride = $env:REF40
          msbuild shadowsocks-csharp/shadowsocks-csharp4.0.csproj /p:Configuration=Release /p:Platform=AnyCPU /m

      - name: Package artifacts
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          New-Item -ItemType Directory -Path artifacts -Force | Out-Null
          $version = "${{ github.ref_name }}"
          if (-not $version) {
            $version = (Get-Date -Format 'yyyyMMdd-HHmmss')
          }
          $projectRoot = Join-Path (Get-Location) 'shadowsocks-csharp'
          $targets = @(
            @{ Name = 'ShadowsocksR-dotnet2.0'; Path = 'bin\2.0\Release' },
            @{ Name = 'ShadowsocksR-dotnet4.0'; Path = 'bin\4.0\Release' }
          )
          foreach ($target in $targets) {
            $source = Join-Path $projectRoot $target.Path
            if (Test-Path $source) {
              $zipPath = Join-Path 'artifacts' ("{0}-{1}.zip" -f $target.Name, $version)
              Compress-Archive -Path (Join-Path $source '*') -DestinationPath $zipPath -Force
            } else {
              Write-Host "Skip missing output folder: $($target.Path)"
            }
          }

      - name: Package Windows distribution folder (extras + dual exe)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $version = "${{ github.ref_name }}"
          if (-not $version) { $version = (Get-Date -Format 'yyyyMMdd-HHmmss') }
          $projectRoot = Join-Path (Get-Location) 'shadowsocks-csharp'
          $distRoot = Join-Path (Get-Location) ("dist/ShadowsocksR-win-{0}" -f $version)
          New-Item -ItemType Directory -Path $distRoot -Force | Out-Null
          $templates = Join-Path $distRoot 'templates'
          New-Item -ItemType Directory -Path $templates -Force | Out-Null

          # Copy executables if present and rename to match historical naming
          $exe20 = Join-Path $projectRoot 'bin/2.0/Release/ShadowsocksR.exe'
          if (Test-Path $exe20) { Copy-Item $exe20 (Join-Path $distRoot 'ShadowsocksR-dotnet2.0.exe') -Force }
          $exe40 = Join-Path $projectRoot 'bin/4.0/Release/ShadowsocksR.exe'
          if (Test-Path $exe40) { Copy-Item $exe40 (Join-Path $distRoot 'ShadowsocksR-dotnet4.0.exe') -Force }

          # Root extras
          foreach ($f in @('LICENSE','chn_ip.txt')) {
            $src = Join-Path (Get-Location) $f
            if (Test-Path $src) { Copy-Item $src (Join-Path $distRoot (Split-Path $src -Leaf)) -Force }
          }
          $userRule = Join-Path $projectRoot 'Data/user-rule.txt'
          if (Test-Path $userRule) { Copy-Item $userRule (Join-Path $distRoot 'user.rule') -Force }

          # Template files
          foreach ($f in @('privoxy_conf.txt','proxy.pac.txt.gz','cn.txt','zh-tw.txt')) {
            $src = Join-Path $projectRoot ("Data/{0}" -f $f)
            if (Test-Path $src) { Copy-Item $src (Join-Path $templates (Split-Path $src -Leaf)) -Force }
          }

          # Zip distribution folder
          New-Item -ItemType Directory -Path 'artifacts' -Force | Out-Null
          $zipPath = Join-Path 'artifacts' ("ShadowsocksR-win-{0}.zip" -f $version)
          Compress-Archive -Path (Join-Path $distRoot '*') -DestinationPath $zipPath -Force

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ssr-windows
          path: artifacts\*.zip

  release:
    needs: build
    runs-on: windows-2022
    permissions:
      contents: write
    steps:
      - name: Compute release tag
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          if ('${{ startsWith(github.ref, 'refs/tags/') }}' -eq 'true') {
            $tag = '${{ github.ref_name }}'
          } else {
            $tag = 'nightly-' + (Get-Date -Format 'yyyyMMdd-HHmmss')
          }
          "REL_TAG=$tag" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Download packaged artifacts
        uses: actions/download-artifact@v4
        with:
          name: ssr-windows
          path: .

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: "*.zip"
          tag_name: ${{ env.REL_TAG }}
          prerelease: ${{ !startsWith(github.ref, 'refs/tags/') }}
          name: SSR Windows ${{ env.REL_TAG }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
