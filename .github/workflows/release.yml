name: Build and Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup NuGet
        uses: nuget/setup-nuget@v1

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Install .NET Framework 4.0 targeting pack
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $downloadPage = Invoke-WebRequest -Uri 'https://dotnet.microsoft.com/download/dotnet-framework/thank-you/net40-offline-installer'
          $match = ($downloadPage.Content | Select-String -Pattern 'https://download\.microsoft\.com/[^\"]+\.exe' -AllMatches).Matches
          if (-not $match -or $match.Count -eq 0) {
            throw "Failed to locate .NET Framework 4.0 installer link."
          }
          $url = $match[0].Value
          $file = Join-Path $env:RUNNER_TEMP ([System.IO.Path]::GetFileName($url))
          Write-Host "Downloading $url"
          Invoke-WebRequest -Uri $url -OutFile $file
          Write-Host "Installing $file"
          Start-Process -FilePath $file -ArgumentList '/passive /norestart' -Wait

      - name: Restore packages
        run: nuget restore shadowsocks-csharp.sln

      - name: Build Release binaries
        run: msbuild shadowsocks-csharp.sln /p:Configuration=Release /p:Platform="Any CPU" /m

      - name: Package artifacts
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          New-Item -ItemType Directory -Path artifacts -Force | Out-Null
          $version = "${{ github.ref_name }}"
          if (-not $version) {
            $version = (Get-Date -Format 'yyyyMMdd-HHmmss')
          }
          $projectRoot = Join-Path (Get-Location) 'shadowsocks-csharp'
          $targets = @(
            @{ Name = 'ShadowsocksR-dotnet2.0'; Path = 'bin\2.0\Release' },
            @{ Name = 'ShadowsocksR-dotnet4.0'; Path = 'bin\4.0\Release' }
          )
          foreach ($target in $targets) {
            $source = Join-Path $projectRoot $target.Path
            if (Test-Path $source) {
              $zipPath = Join-Path 'artifacts' ("{0}-{1}.zip" -f $target.Name, $version)
              Compress-Archive -Path (Join-Path $source '*') -DestinationPath $zipPath -Force
            } else {
              Write-Host "Skip missing output folder: $($target.Path)"
            }
          }

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ssr-windows
          path: artifacts\*.zip

  release:
    needs: build
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download packaged artifacts
        uses: actions/download-artifact@v4
        with:
          name: ssr-windows

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: "*.zip"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
